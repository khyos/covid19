<!DOCTYPE html>
<html>
<header>
	<script src="Chart.bundle.min.js"></script>
	<script type="text/javascript">
		let oLoadedData;
		const aCountryNames = ['Chine', 'Corée du Sud', 'Italie', 'France', 'États-Unis', 'Japon'];
		const aColors = ['#5899DA', '#E8743B', '#19A979', '#ED4A7B', '#945ECF', '#13A4B4', '#525DF4', '#BF399E', '#6C8893', '#EE6868', '#2F6497'];
	
		function loadJSON() {
			fetch("https://raw.githubusercontent.com/khyos/covid19/master/covid19-data.json").then((response) => {
				return response.json();
			})
			.then((oData) => {
				oLoadedData = oData;
				const sMinDate = "2020-01-22";
				const sMaxDate = "2020-03-08";
				const oDataSets = getDataSets(oLoadedData, aCountryNames, sMinDate, sMaxDate);
				createCharts(oDataSets, aCountryNames, aColors);
			});
		}
		
		function createCharts(oDataSets, aCountryNames, aColors) {
			const aCurrentDatasets = [];
			const aProgressionDatasets = [];
			const aProgressionPercentDatasets = [];
			for (let i = 0; i < aCountryNames.length; i++) {
				const sCountry = aCountryNames[i];
				aCurrentDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].Current
				});
				aProgressionDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].Progression
				});
				aProgressionPercentDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].ProgressionPercent
				});
			}
		
			const currentCtx = document.getElementById('current').getContext('2d');				
			const chartCtx = new Chart(currentCtx, {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aCurrentDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false
				}
			});
			
			const progressionCtx = document.getElementById('progression').getContext('2d');				
			const progressionChart = new Chart(progressionCtx, {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aProgressionDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false
				}
			});
			
			const progressionPercentCtx = document.getElementById('progressionPercent').getContext('2d');				
			const progressionPercentChart = new Chart(progressionPercentCtx, {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aProgressionPercentDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false
				}
			});
		}
		
		function getDataSets(oData, aCountryNames, sStartDate, sEndDate) {
			const oCountriesData = oData.PaysData;
			const mDates = {};
			
			oCountriesData.forEach((line) => {
				line.FinalDate = line.Date.split('T')[0];
				if (!mDates[line.FinalDate]) {
					mDates[line.FinalDate] = {};
				}
				mDates[line.FinalDate][line.Pays] = line;
			});
			
			const aDates = Object.keys(mDates);
			aDates.sort((oDateA, oDateB) => {
				return oDateA.localeCompare(oDateB);
			});
			
			const mCountries = {};
			
			for (let i = 0; i < aCountryNames.length; i++) {
				mCountries[aCountryNames[i]] = {
					Current: [],
					Progression: [],
					ProgressionPercent: []
				};
			};
			
			for (let i = 0; i < aDates.length; i++) {
				const sPreviousDate = aDates[i - 1];
				const sDate = aDates[i];
				for (let j = 0; j < aCountryNames.length; j++) {
					const sCountryName = aCountryNames[j];
					const oLine = mDates[sDate][sCountryName];
					if (oLine) {
						oLine.Current = oLine.Infection - oLine.Guerisons - oLine.Deces;
						const oPreviousLine = sPreviousDate ? mDates[sPreviousDate][sCountryName] : null;
						if (oPreviousLine) {
							oLine.Progression = oLine.Current - oPreviousLine.Current;
							oLine.ProgressionPercent = oLine.Progression / oPreviousLine.Current * 100;
						} else {
							oLine.Progression = oLine.Current;
							oLine.ProgressionPercent = 0;
						}
					} else {
						
					}
				};
			}
			
			const aFinalDates = [];
			for (let i = 0; i < aDates.length; i++) {
				const sDate = aDates[i];
				if (sDate.localeCompare(sStartDate) >= 0 && sDate.localeCompare(sEndDate) <= 0) {
					aFinalDates.push(sDate);
					for (let j = 0; j < aCountryNames.length; j++) {
						const sCountryName = aCountryNames[j];
						mCountries[sCountryName].Current.push(mDates[sDate][sCountryName] ? mDates[sDate][sCountryName].Current : 0);
						mCountries[sCountryName].Progression.push(mDates[sDate][sCountryName] ? mDates[sDate][sCountryName].Progression : 0);
						mCountries[sCountryName].ProgressionPercent.push(mDates[sDate][sCountryName] ? mDates[sDate][sCountryName].ProgressionPercent : 0);
					}
				}
			}
			
			return {
				dates: aFinalDates,
				countries: mCountries
			};
		};
		
		function updateDates() {
			const sMinDate = document.getElementById('startDate').value;
			const sMaxDate = document.getElementById('endDate').value;
			const oDataSets = getDataSets(oLoadedData, aCountryNames, sMinDate, sMaxDate);
			createCharts(oDataSets, aCountryNames, aColors);
		};
	</script>
</header>
<body onload="loadJSON()">
	<div>Start Date: <input type="date" id="startDate" value="2020-01-22" min="2020-01-22" max="2020-03-08" onchange="updateDates()"/> End Date: <input type="date" id="endDate" value="2020-03-08" min="2020-01-22" max="2020-03-08" onchange="updateDates()"/></div>
	<br /><br />
	<div>Current number of infected person</div>
	<div style="width: 100%: height: 500px">
		<canvas id="current" width="400" height="400"></canvas>
	</div>
	<br /><br />
	<div>Day by day evolution of the number of infected person</div>
	<div style="width: 100%: height: 500px">
		<canvas id="progression" width="400" height="400"></canvas>
	</div>
	<br /><br />
	<div>Day by day evolution of the number of infected person in %</div>
	<div style="width: 100%: height: 500px">
		<canvas id="progressionPercent" width="400" height="400"></canvas>
	</div>
	<br /><br />
	<div>Data from: <a href="https://www.data.gouv.fr/fr/datasets/coronavirus-covid19-evolution-par-pays-et-dans-le-monde-maj-quotidienne/">https://www.data.gouv.fr/fr/datasets/coronavirus-covid19-evolution-par-pays-et-dans-le-monde-maj-quotidienne/</a></div>
</body>
</html>