<!DOCTYPE html>
<html>
<header>
	<script src="Chart.bundle.min.js"></script>
	<script type="text/javascript">
		let oLoadedData;
		let sMinDate = "2020-01-22";
		let sMaxDate = "2020-03-15";
		let currentChart;
		let progressionChart;
		let progressionPercentChart;
		let current100Chart;
		let death100Chart;
		let bCurrentLog = false;
		let bCurrent100Log = false;
		let bDeath100Log = false;
		const aCountryNames = ['Chine', 'Corée du Sud', 'Italie', 'France', 'États-Unis', 'Japon', 'Allemagne', 'Espagne'];
		const aColors = ['#5899DA', '#E8743B', '#19A979', '#ED4A7B', '#945ECF', '#13A4B4', '#525DF4', '#BF399E', '#6C8893', '#EE6868', '#2F6497'];
	
		function loadJSON() {
			fetch("https://raw.githubusercontent.com/khyos/covid19/master/covid19-data.json").then((response) => {
				return response.json();
			})
			.then((oData) => {
				oLoadedData = oData;
				const aAllCountries = [];
				oData.PaysData.forEach((line) => {
					if (aAllCountries.indexOf(line.Pays) === -1) {
						aAllCountries.push(line.Pays);
					}
				});
				aAllCountries.sort((sCountryA, sCountryB) => {
					return sCountryA.localeCompare(sCountryB);
				});
				const oCountriesFilter = document.getElementById("countriesFilter");
				aAllCountries.forEach((sCountry) => {
					const oCheckBox = document.createElement("INPUT");
					oCheckBox.setAttribute('type', 'checkbox');
					oCheckBox.setAttribute('id', 'sCountry');
					oCheckBox.checked = aCountryNames.indexOf(sCountry) >= 0;
					oCountriesFilter.append(oCheckBox);
					oCheckBox.addEventListener('change', function() {
						if (this.checked && aCountryNames.indexOf(sCountry) === -1) {
							aCountryNames.push(sCountry);
						} else if (!this.checked && aCountryNames.indexOf(sCountry) >= 0) {
							aCountryNames.splice(aCountryNames.indexOf(sCountry), 1);
						}
						updateCharts();
					});
					const oLabel = document.createElement("LABEL");
					oLabel.innerHTML = sCountry;
					oCountriesFilter.append(oLabel);
				});
				const oDataSets = getDataSets(oLoadedData, aCountryNames, sMinDate, sMaxDate);
				createCharts(oDataSets, aCountryNames, aColors);
			});
		}
		
		function createCharts(oDataSets, aCountryNames, aColors) {
			const aCurrentDatasets = [];
			const aProgressionDatasets = [];
			const aProgressionPercentDatasets = [];
			const aCurrent100Datasets = [];
			const aDeath100Datasets = [];
			for (let i = 0; i < aCountryNames.length; i++) {
				const sCountry = aCountryNames[i];
				aCurrentDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].Current
				});
				aProgressionDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].Progression
				});
				aProgressionPercentDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].ProgressionPercent
				});
				aCurrent100Datasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries100[sCountry].Current
				});
				aDeath100Datasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries100[sCountry].Death
				});
			}
			
			if (currentChart) {
				currentChart.destroy();
			}
			const currentCtx = document.getElementById('current').getContext('2d');
			const oCurrentChartConf = {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aCurrentDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: true
				}
			}
			
			if (bCurrentLog) {
				oCurrentChartConf.options.scales = {
					yAxes: [{
						type: 'logarithmic',
						ticks: {
						min: 0,
						max: 100000,
						callback: function(value, index, values) {//needed to change the scientific notation results from using logarithmic scale
							return Number(value.toString());//pass tick values as a string into Number function
						}
					},
					afterBuildTicks: function(pckBarChart) {    
						pckBarChart.ticks = [];
						pckBarChart.ticks.push(10);
						pckBarChart.ticks.push(100);
						pckBarChart.ticks.push(1000);
						pckBarChart.ticks.push(10000);
						pckBarChart.ticks.push(100000);
					  }
					}]
				};
			}
			currentChart = new Chart(currentCtx, oCurrentChartConf);
			
			if (progressionChart) {
				progressionChart.destroy();
			}
			const progressionCtx = document.getElementById('progression').getContext('2d');			
			progressionChart = new Chart(progressionCtx, {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aProgressionDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false
				}
			});
			
			if (progressionPercentChart) {
				progressionPercentChart.destroy();
			}
			const progressionPercentCtx = document.getElementById('progressionPercent').getContext('2d');				
			progressionPercentChart = new Chart(progressionPercentCtx, {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aProgressionPercentDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false
				}
			});
			
			if (current100Chart) {
				current100Chart.destroy();
			}
			const current100Ctx = document.getElementById('current100').getContext('2d');
			const oCurrent100ChartConf = {
				type: 'line',
				data: {
					labels: oDataSets.dates100,
					datasets: aCurrent100Datasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: true
				}
			}
			
			if (bCurrent100Log) {
				oCurrent100ChartConf.options.scales = {
					yAxes: [{
						type: 'logarithmic',
						ticks: {
						min: 0,
						max: 100000,
						callback: function(value, index, values) {//needed to change the scientific notation results from using logarithmic scale
							return Number(value.toString());//pass tick values as a string into Number function
						}
					},
					afterBuildTicks: function(pckBarChart) {    
						pckBarChart.ticks = [];
						pckBarChart.ticks.push(10);
						pckBarChart.ticks.push(100);
						pckBarChart.ticks.push(1000);
						pckBarChart.ticks.push(10000);
						pckBarChart.ticks.push(100000);
					  }
					}]
				};
			}
			current100Chart = new Chart(current100Ctx, oCurrent100ChartConf);
			
			if (death100Chart) {
				death100Chart.destroy();
			}
			const death100Ctx = document.getElementById('death100').getContext('2d');
			const oDeath100ChartConf = {
				type: 'line',
				data: {
					labels: oDataSets.dates100,
					datasets: aDeath100Datasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: true
				}
			}
			
			if (bDeath100Log) {
				oDeath100ChartConf.options.scales = {
					yAxes: [{
						type: 'logarithmic',
						ticks: {
						min: 0,
						max: 100000,
						callback: function(value, index, values) {//needed to change the scientific notation results from using logarithmic scale
							return Number(value.toString());//pass tick values as a string into Number function
						}
					},
					afterBuildTicks: function(pckBarChart) {    
						pckBarChart.ticks = [];
						pckBarChart.ticks.push(10);
						pckBarChart.ticks.push(100);
						pckBarChart.ticks.push(1000);
						pckBarChart.ticks.push(10000);
						pckBarChart.ticks.push(100000);
					  }
					}]
				};
			}
			death100Chart = new Chart(death100Ctx, oDeath100ChartConf);
		}
		
		function getDataSets(oData, aCountryNames, sStartDate, sEndDate) {
			const oCountriesData = oData.PaysData;
			const mDates = {};
			
			oCountriesData.forEach((line) => {
				line.FinalDate = line.Date.split('T')[0];
				if (!mDates[line.FinalDate]) {
					mDates[line.FinalDate] = {};
				}
				mDates[line.FinalDate][line.Pays] = line;
			});
			
			const aDates = Object.keys(mDates);
			aDates.sort((oDateA, oDateB) => {
				return oDateA.localeCompare(oDateB);
			});
			
			const mCountries = {};
			
			for (let i = 0; i < aCountryNames.length; i++) {
				mCountries[aCountryNames[i]] = {
					Current: [],
					Progression: [],
					ProgressionPercent: []
				};
			};
			
			const mCountries100 = {};
			for (let i = 0; i < aDates.length; i++) {
				const sPreviousDate = aDates[i - 1];
				const sDate = aDates[i];
				for (let j = 0; j < aCountryNames.length; j++) {
					const sCountryName = aCountryNames[j];
					const oLine = mDates[sDate][sCountryName];
					if (oLine) {
						oLine.Current = oLine.Infection - oLine.Guerisons - oLine.Deces;
						if (oLine.Current >= 100) {
							if (!mCountries100[sCountryName]) {
								mCountries100[sCountryName] = {
									Current: [],
									Death: []
								};
							} 
							mCountries100[sCountryName].Current.push(oLine.Current);
							mCountries100[sCountryName].Death.push(oLine.Deces);
						}
						const oPreviousLine = sPreviousDate ? mDates[sPreviousDate][sCountryName] : null;
						if (oPreviousLine) {
							oLine.Progression = oLine.Current - oPreviousLine.Current;
							oLine.ProgressionPercent = oLine.Progression / oPreviousLine.Current * 100;
						} else {
							oLine.Progression = oLine.Current;
							oLine.ProgressionPercent = 0;
						}
					}
				};
			}
			
			const aFinalDates = [];
			for (let i = 0; i < aDates.length; i++) {
				const sDate = aDates[i];
				if (sDate.localeCompare(sStartDate) >= 0 && sDate.localeCompare(sEndDate) <= 0) {
					aFinalDates.push(sDate);
					for (let j = 0; j < aCountryNames.length; j++) {
						const sCountryName = aCountryNames[j];
						mCountries[sCountryName].Current.push(mDates[sDate][sCountryName] ? mDates[sDate][sCountryName].Current : 0);
						mCountries[sCountryName].Progression.push(mDates[sDate][sCountryName] ? mDates[sDate][sCountryName].Progression : 0);
						mCountries[sCountryName].ProgressionPercent.push(mDates[sDate][sCountryName] ? mDates[sDate][sCountryName].ProgressionPercent : 0);
					}
				}
			}
			
			let iDateNb = 0;
			for (let i = 0; i < aCountryNames.length; i++) {
				const sCountryName = aCountryNames[i];
				if (mCountries100[sCountryName].Current.length > iDateNb) {
					iDateNb = mCountries100[sCountryName].Current.length;
				}
			}
			const aDates100 = [];
			for (let i = 0; i < iDateNb; i++) {
				aDates100.push(i);
			}
			
			return {
				dates: aFinalDates,
				countries: mCountries,
				dates100: aDates100,
				countries100: mCountries100
			};
		};
		
		function updateCharts() {
			sMinDate = document.getElementById('startDate').value;
			sMaxDate = document.getElementById('endDate').value;
			bCurrentLog = document.getElementById('currentLog').checked;
			bCurrent100Log = document.getElementById('current100Log').checked;
			bDeath100Log = document.getElementById('death100Log').checked;
			const oDataSets = getDataSets(oLoadedData, aCountryNames, sMinDate, sMaxDate);
			createCharts(oDataSets, aCountryNames, aColors);
		};
	</script>
</header>
<body onload="loadJSON()">
	<div>Start Date: <input type="date" id="startDate" value="2020-01-22" min="2020-01-22" max="2020-03-15" onchange="updateCharts()"/> End Date: <input type="date" id="endDate" value="2020-03-15" min="2020-01-22" max="2020-03-15" onchange="updateCharts()"/></div>
	<br /><br />
	<div>
		<div style="display: inline-block;">
			<div>Current number of infected persons <input type="checkbox" id="currentLog" onchange="updateCharts()"/>Log</div>
			<div style="width: 600px; height: 600px;">
				<canvas id="current" width="500" height="500"></canvas>
			</div>
		</div>
		<div style="display: inline-block;">
			<div>Day by day evolution of the number of infected person</div>
			<div style="width: 600px; height: 600px;">
				<canvas id="progression" width="500" height="500"></canvas>
			</div>
		</div>
		<div style="display: inline-block;">
			<div>Day by day evolution of the number of infected person in %</div>
			<div style="width: 600px; height: 600px;">
				<canvas id="progressionPercent" width="500" height="500"></canvas>
			</div>
		</div>
		<div style="display: inline-block;">
			<div>Number of infected persons from day 100 <input type="checkbox" id="current100Log" onchange="updateCharts()"/>Log</div>
			<div style="width: 600px; height: 600px;">
				<canvas id="current100" width="500" height="500"></canvas>
			</div>
		</div>
		<div style="display: inline-block;">
			<div>Number of deaths from day 100 <input type="checkbox" id="death100Log" onchange="updateCharts()"/>Log</div>
			<div style="width: 600px; height: 600px;">
				<canvas id="death100" width="500" height="500"></canvas>
			</div>
		</div>
	</div>
	<br /><br />
	<div id="countriesFilter">
	</div>
	<br /><br />
	<div>Data from: <a href="https://www.data.gouv.fr/fr/datasets/coronavirus-covid19-evolution-par-pays-et-dans-le-monde-maj-quotidienne/">https://www.data.gouv.fr/fr/datasets/coronavirus-covid19-evolution-par-pays-et-dans-le-monde-maj-quotidienne/</a></div>
</body>
</html>
