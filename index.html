<!DOCTYPE html>
<html style="width: 100%; height: 100%">
<head>
	<script src="Chart.bundle.min.js"></script>
	<script type="text/javascript">
		let oLoadedData;
		
		let sMinDate = "2020-01-22";
		let sMaxDate = "2020-01-22";
		
		let currentChart;
		let progressionChart;
		let progressionPercentChart;
		let current100Chart;
		let death100Chart;
		
		let bCurrentLog = false;
		let bCurrent100Log = false;
		let bDeath100Log = false;
		
		let mDates;
		let aDates;
		let mCountries;
		let aCountries;
		
		let aSelectedCountries;
		const aColors = ['#5899DA', '#E8743B', '#19A979', '#ED4A7B', '#945ECF', '#13A4B4', '#525DF4', '#BF399E', '#6C8893', '#EE6868', '#2F6497'];
	
		function loadJSON() {
			fetch("https://raw.githubusercontent.com/khyos/covid19/master/covid19-data.json").then((response) => {
				return response.json();
			})
			.then((oData) => {
				oLoadedData = oData;
				const oCountriesData = oData.PaysData;
				
				mDates = {};
				mCountries = {};
				oCountriesData.forEach((line) => {
					line.FinalDate = line.Date.split('T')[0];
					if (line.FinalDate.localeCompare(sMinDate) < 0) {
						sMinDate = line.FinalDate;
					}
					if (line.FinalDate.localeCompare(sMaxDate) > 0) {
						sMaxDate = line.FinalDate;
					}
					if (!mDates[line.FinalDate]) {
						mDates[line.FinalDate] = {};
					}
					mDates[line.FinalDate][line.Pays] = line;
					if (!mCountries[line.Pays]) {
						mCountries[line.Pays] = {};
					}
					mCountries[line.Pays][line.FinalDate] = line;
				});
				
				aDates = Object.keys(mDates);
				aDates.sort((oDateA, oDateB) => {
					return oDateA.localeCompare(oDateB);
				});
				aCountries = Object.keys(mCountries);
				
				for (let i = 0; i < aDates.length; i++) {
					const sPreviousDate = aDates[i - 1];
					const sDate = aDates[i];
					for (let j = 0; j < aCountries.length; j++) {
						const sCountry = aCountries[j];
						const oLine = mDates[sDate][sCountry];
						if (oLine) {
							oLine.Current = oLine.Infection - oLine.Guerisons - oLine.Deces;
							const oPreviousLine = sPreviousDate ? mDates[sPreviousDate][sCountry] : null;
							if (oPreviousLine) {
								oLine.Progression = oLine.Current - oPreviousLine.Current;
								oLine.ProgressionPercent = oLine.Progression / oPreviousLine.Current * 100;
							} else {
								oLine.Progression = oLine.Current;
								oLine.ProgressionPercent = 0;
							}
						}
					};
				}
				
				aCountries.sort((sCountryA, sCountryB) => {
					if (!mCountries[sCountryA][sMaxDate]) {
						return 1;
					}
					if (!mCountries[sCountryB][sMaxDate]) {
						return -1;
					}
					return mCountries[sCountryB][sMaxDate].Current - mCountries[sCountryA][sMaxDate].Current;
				});
				aSelectedCountries = [];
				for (let i = 0; i < 8; i++) {
					aSelectedCountries.push(aCountries[i]);
				}
				
				const iMaxCurrent = mCountries[aCountries[0]][sMaxDate].Current;
				const oCountriesFilter = document.getElementById("countriesFilter");
				aCountries.forEach((sCountry) => {
					const oLi = document.createElement("li");
					let iFillPercent = mCountries[sCountry][sMaxDate] ? (mCountries[sCountry][sMaxDate].Current / iMaxCurrent) * 100 : 0;
					oLi.style.backgroundImage = "linear-gradient(to right, #cadded " + iFillPercent + "%, white " + iFillPercent + "%)";
					const oCheckBox = document.createElement("INPUT");
					oCheckBox.setAttribute('type', 'checkbox');
					oCheckBox.setAttribute('id', sCountry);
					oCheckBox.checked = aSelectedCountries.indexOf(sCountry) >= 0;
					oLi.append(oCheckBox);
					oCheckBox.addEventListener('change', function() {
						if (this.checked && aSelectedCountries.indexOf(sCountry) === -1) {
							aSelectedCountries.push(sCountry);
						} else if (!this.checked && aSelectedCountries.indexOf(sCountry) >= 0) {
							aSelectedCountries.splice(aSelectedCountries.indexOf(sCountry), 1);
						}
						updateCharts();
					});
					const oLabel = document.createElement("LABEL");
					oLabel.innerHTML = sCountry;
					oLabel.htmlFor = sCountry;
					oLi.append(oLabel);
					oCountriesFilter.append(oLi);
				});
				
				const oStartDateInput = document.getElementById('startDate');
				oStartDateInput.value = sMinDate;
				oStartDateInput.setAttribute('min', sMinDate);
				oStartDateInput.setAttribute('max', sMaxDate);
				const oEndDateInput = document.getElementById('endDate');
				oEndDateInput.value = sMaxDate;
				oEndDateInput.setAttribute('min', sMinDate);
				oEndDateInput.setAttribute('max', sMaxDate);
				
				const oDataSets = getDataSets(oLoadedData);
				createCharts(oDataSets);
			});
		}
		
		function createCharts(oDataSets) {
			const aCurrentDatasets = [];
			const aProgressionDatasets = [];
			const aProgressionPercentDatasets = [];
			const aCurrent100Datasets = [];
			const aDeath100Datasets = [];
			for (let i = 0; i < aSelectedCountries.length; i++) {
				const sCountry = aSelectedCountries[i];
				aCurrentDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].Current
				});
				aProgressionDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].Progression
				});
				aProgressionPercentDatasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries[sCountry].ProgressionPercent
				});
				aCurrent100Datasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries100[sCountry].Current
				});
				aDeath100Datasets.push({
					label: sCountry,
					fill: false,
					borderColor: aColors[i],
					data: oDataSets.countries100[sCountry].Death
				});
			}
			
			if (currentChart) {
				currentChart.destroy();
			}
			const currentCtx = document.getElementById('current').getContext('2d');
			const oCurrentChartConf = {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aCurrentDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: true
				}
			}
			
			if (bCurrentLog) {
				oCurrentChartConf.options.scales = {
					yAxes: [{
						type: 'logarithmic',
						ticks: {
						min: 0,
						max: 100000,
						callback: function(value, index, values) {//needed to change the scientific notation results from using logarithmic scale
							return Number(value.toString());//pass tick values as a string into Number function
						}
					},
					afterBuildTicks: function(pckBarChart) {    
						pckBarChart.ticks = [];
						pckBarChart.ticks.push(10);
						pckBarChart.ticks.push(100);
						pckBarChart.ticks.push(1000);
						pckBarChart.ticks.push(10000);
						pckBarChart.ticks.push(100000);
					  }
					}]
				};
			}
			currentChart = new Chart(currentCtx, oCurrentChartConf);
			
			if (progressionChart) {
				progressionChart.destroy();
			}
			const progressionCtx = document.getElementById('progression').getContext('2d');			
			progressionChart = new Chart(progressionCtx, {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aProgressionDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false
				}
			});
			
			if (progressionPercentChart) {
				progressionPercentChart.destroy();
			}
			const progressionPercentCtx = document.getElementById('progressionPercent').getContext('2d');				
			progressionPercentChart = new Chart(progressionPercentCtx, {
				type: 'line',
				data: {
					labels: oDataSets.dates,
					datasets: aProgressionPercentDatasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false
				}
			});
			
			if (current100Chart) {
				current100Chart.destroy();
			}
			const current100Ctx = document.getElementById('current100').getContext('2d');
			const oCurrent100ChartConf = {
				type: 'line',
				data: {
					labels: oDataSets.dates100,
					datasets: aCurrent100Datasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: true
				}
			}
			
			if (bCurrent100Log) {
				oCurrent100ChartConf.options.scales = {
					yAxes: [{
						type: 'logarithmic',
						ticks: {
						min: 0,
						max: 100000,
						callback: function(value, index, values) {
							return Number(value.toString());
						}
					},
					afterBuildTicks: function(pckBarChart) {    
						pckBarChart.ticks = [];
						pckBarChart.ticks.push(10);
						pckBarChart.ticks.push(100);
						pckBarChart.ticks.push(1000);
						pckBarChart.ticks.push(10000);
						pckBarChart.ticks.push(100000);
					  }
					}]
				};
			}
			current100Chart = new Chart(current100Ctx, oCurrent100ChartConf);
			
			if (death100Chart) {
				death100Chart.destroy();
			}
			const death100Ctx = document.getElementById('death100').getContext('2d');
			const oDeath100ChartConf = {
				type: 'line',
				data: {
					labels: oDataSets.dates100,
					datasets: aDeath100Datasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: true
				}
			}
			
			if (bDeath100Log) {
				oDeath100ChartConf.options.scales = {
					yAxes: [{
						type: 'logarithmic',
						ticks: {
						min: 0,
						max: 100000,
						callback: function(value, index, values) {
							return Number(value.toString());
						}
					},
					afterBuildTicks: function(pckBarChart) {    
						pckBarChart.ticks = [];
						pckBarChart.ticks.push(10);
						pckBarChart.ticks.push(100);
						pckBarChart.ticks.push(1000);
						pckBarChart.ticks.push(10000);
						pckBarChart.ticks.push(100000);
					  }
					}]
				};
			}
			death100Chart = new Chart(death100Ctx, oDeath100ChartConf);
		}
		
		function getDataSets(oData) {
			const mCountries = {};
			
			for (let i = 0; i < aSelectedCountries.length; i++) {
				mCountries[aSelectedCountries[i]] = {
					Current: [],
					Progression: [],
					ProgressionPercent: []
				};
			};
			
			const aFinalDates = [];
			for (let i = 0; i < aDates.length; i++) {
				const sDate = aDates[i];
				if (sDate.localeCompare(sMinDate) >= 0 && sDate.localeCompare(sMaxDate) <= 0) {
					aFinalDates.push(sDate);
					for (let j = 0; j < aSelectedCountries.length; j++) {
						const sSelectedCountry = aSelectedCountries[j];
						mCountries[sSelectedCountry].Current.push(mDates[sDate][sSelectedCountry] ? mDates[sDate][sSelectedCountry].Current : 0);
						mCountries[sSelectedCountry].Progression.push(mDates[sDate][sSelectedCountry] ? mDates[sDate][sSelectedCountry].Progression : 0);
						mCountries[sSelectedCountry].ProgressionPercent.push(mDates[sDate][sSelectedCountry] ? mDates[sDate][sSelectedCountry].ProgressionPercent : 0);
					}
				}
			}
			
			const mCountries100 = {};
			for (let i = 0; i < aDates.length; i++) {
				const sPreviousDate = aDates[i - 1];
				const sDate = aDates[i];
				for (let j = 0; j < aSelectedCountries.length; j++) {
					const sSelectedCountry = aSelectedCountries[j];
					const oLine = mDates[sDate][sSelectedCountry];
					if (oLine && oLine.Current >= 100) {
						if (!mCountries100[sSelectedCountry]) {
							mCountries100[sSelectedCountry] = {
								Current: [],
								Death: []
							};
						} 
						mCountries100[sSelectedCountry].Current.push(oLine.Current);
						mCountries100[sSelectedCountry].Death.push(oLine.Deces);
					}
				};
			}
			
			
			
			let iDateNb = 0;
			for (let i = 0; i < aSelectedCountries.length; i++) {
				const sSelectedCountry = aSelectedCountries[i];
				if (mCountries100[sSelectedCountry].Current.length > iDateNb) {
					iDateNb = mCountries100[sSelectedCountry].Current.length;
				}
			}
			const aDates100 = [];
			for (let i = 0; i < iDateNb; i++) {
				aDates100.push(i);
			}
			
			return {
				dates: aFinalDates,
				countries: mCountries,
				dates100: aDates100,
				countries100: mCountries100
			};
		};
		
		function updateCharts() {
			sMinDate = document.getElementById('startDate').value;
			sMaxDate = document.getElementById('endDate').value;
			bCurrentLog = document.getElementById('currentLog').checked;
			bCurrent100Log = document.getElementById('current100Log').checked;
			bDeath100Log = document.getElementById('death100Log').checked;
			const oDataSets = getDataSets(oLoadedData);
			createCharts(oDataSets);
		};
	</script>
	<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
	<style>
		body {
			font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
			font-size: 14px;
		}
	
		.countriesFilter {
			margin: 0px;
			margin-block-start: 0em;
			margin-block-end: 0em;
			margin-inline-start: 0px;
			margin-inline-end: 0px;
			padding-inline-start: 0px;
		}
		.countriesFilter>li {
			display: block;
		}
		
		.chartTile {
			display: inline-block;
			margin: 20px;
		}
		.chartLabel {
			height: 20px;
			line-height: 20px;
		}
		.chartLabel>div {
			float: right;
		}
		
		.canvasContainer {
			width: 600px;
			height: 600px;
		}
	</style>
</head>
<body onload="loadJSON()" style="margin: 0px; width: 100%; height: 100%">
	<div style="height: 30px; line-height: 30px;">Start Date: <input type="date" id="startDate" onchange="updateCharts()"/> End Date: <input type="date" id="endDate" onchange="updateCharts()"/></div>
	<div style="display: flex; width: 100%; height: calc(100% - 55px);">
		<div style="width: 200px; height: 100%; overflow-y: auto;">
			<ul id="countriesFilter" class="countriesFilter"></ul>
		</div>
		<div style="width: calc(100% - 200px); height: 100%; overflow-y: auto;">
			<div class="chartTile">
				<div class="chartLabel">
					<label>Current number of infected persons</label>
					<div>
						<input type="checkbox" id="currentLog" onchange="updateCharts()"/>
						<label for="currentLog">Logarithmic scale</label>
					</div>
				</div>
				<div class="canvasContainer">
					<canvas id="current" width="600" height="600"></canvas>
				</div>
			</div>
			<div class="chartTile">
				<div class="chartLabel"><label>Day by day evolution of the number of infected person</label></div>
				<div class="canvasContainer">
					<canvas id="progression" width="600" height="600"></canvas>
				</div>
			</div>
			<div class="chartTile">
				<div class="chartLabel"><label>Day by day evolution of the number of infected person in %</label></div>
				<div class="canvasContainer">
					<canvas id="progressionPercent" width="600" height="600"></canvas>
				</div>
			</div>
			<div class="chartTile">
				<div class="chartLabel">
					<label>Number of infected persons from day 100</label>
					<div>
						<input type="checkbox" id="current100Log" onchange="updateCharts()"/>
						<label for="current100Log">Logarithmic scale</label>
					</div>
				</div>
				<div class="canvasContainer">
					<canvas id="current100" width="600" height="600"></canvas>
				</div>
			</div>
			<div class="chartTile">
				<div class="chartLabel">
					<label>Number of deaths from day 100</label>
					<div>
						<input type="checkbox" id="death100Log" onchange="updateCharts()"/>
						<label for="death100Log">Logarithmic scale</label>
					</div>
				</div>
				<div class="canvasContainer">
					<canvas id="death100" width="600" height="600"></canvas>
				</div>
			</div>
		</div>
	</div>
	<div style="height: 24px; line-height: 24px; border-top: 1px solid black;">Data from: <a href="https://www.data.gouv.fr/fr/datasets/coronavirus-covid19-evolution-par-pays-et-dans-le-monde-maj-quotidienne/">https://www.data.gouv.fr/fr/datasets/coronavirus-covid19-evolution-par-pays-et-dans-le-monde-maj-quotidienne/</a></div>
</body>
</html>
